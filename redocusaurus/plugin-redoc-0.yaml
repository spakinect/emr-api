openapi: 3.0.3
info:
  title: Spakinect EMR Integration API
  description: >-
    API for External Electronic Medical Record (EMR) systems to integrate with
    Spakinect telemedicine platform. Provides endpoints for managing
    appointments, retrieving treatments, and checking visit statuses.
  version: 1.0.0
  contact:
    name: Spakinect Support
    email: support@spakinect.com
servers:
  - url: https://us-central1-spakinect-app.cloudfunctions.net/emr
    description: Production Server
  - url: https://us-central1-spakinect-staging.cloudfunctions.net/emr
    description: Staging Server
security:
  - ApiKeyAuth: []
paths:
  /appointments:
    post:
      summary: Create New Appointment
      description: >-
        Creates a new Good Faith Exam (GFE) appointment in the Spakinect system.
        Automatically handles patient creation or lookup based on provided
        details.
      operationId: createAppointment
      tags:
        - Appointments
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAppointmentRequest'
            examples:
              standard_appointment:
                summary: Standard appointment creation
                value:
                  patient_details:
                    first_name: John
                    last_name: Doe
                    email: john.doe@example.com
                    phone: '+1234567890'
                  location_id: loc_12345
                  appointment_time: 1640995200
                  requested_treatments:
                    - Botox Injection
                    - Dermal Filler
      responses:
        '201':
          description: Appointment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAppointmentResponse'
              examples:
                success:
                  summary: Successful appointment creation
                  value:
                    success: true
                    gfe_id: gfe_abc123xyz789
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /treatments:
    get:
      summary: Get Available Treatments
      description: >-
        Retrieves a list of all available treatments that can be requested in
        appointments.
      operationId: getTreatments
      tags:
        - Treatments
      responses:
        '200':
          description: List of available treatments
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TreatmentsResponse'
              examples:
                treatments_list:
                  summary: Available treatments
                  value:
                    data:
                      - id: treatment_001
                        name: Botox Injection
                      - id: treatment_002
                        name: Dermal Filler
                      - id: treatment_003
                        name: Chemical Peel
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: No treatments found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TreatmentsResponse'
              examples:
                empty_list:
                  summary: No treatments available
                  value:
                    data: []
        '500':
          $ref: '#/components/responses/InternalServerError'
  /visits/{gfe_id}:
    get:
      summary: Get Visit Status
      description: >-
        Retrieves the current status and details of a Good Faith Exam (GFE)
        visit by ID. Only returns visits that the authenticated EMR has access
        to based on location permissions.
      operationId: getVisitStatus
      tags:
        - Appointments
      parameters:
        - name: gfe_id
          in: path
          required: true
          description: The unique identifier of the GFE visit
          schema:
            type: string
            example: gfe_abc123xyz789
      responses:
        '200':
          description: Visit status retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VisitStatusResponse'
              examples:
                processing_status:
                  summary: Visit in processing status
                  value:
                    success: true
                    data:
                      gfe_id: gfe_abc123xyz789
                      status: Processing
                      requested_treatments:
                        - Botox Injection
                        - Dermal Filler
                      patient_details:
                        name: John Doe
                        first_name: John
                        last_name: Doe
                        email: john.doe@example.com
                completed_status:
                  summary: Completed visit
                  value:
                    success: true
                    data:
                      gfe_id: gfe_abc123xyz789
                      status: Completed
                      requested_treatments:
                        - Botox Injection
                      patient_details:
                        name: Jane Smith
                        first_name: Jane
                        last_name: Smith
                        email: jane.smith@example.com
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /in-person:
    post:
      summary: Create In-Person Visit
      description: >-
        Creates a new in-person visit in the Spakinect system. This endpoint is
        designed for EMR systems that need to initiate intake workflows for
        patients who will complete their forms on-site.
      operationId: createInPersonVisit
      tags:
        - InPerson
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateInPersonRequest'
            examples:
              standard_intake:
                summary: Standard in person visit creation
                value:
                  patient_details:
                    first_name: Sarah
                    last_name: Johnson
                    dob: 03/15/1985
                  location_id: loc_12345
                  requested_treatments:
                    - Botox Cosmetic
                    - Restylane Lyft
              single_treatment:
                summary: In Person visit with single treatment
                value:
                  patient_details:
                    first_name: Michael
                    last_name: Rodriguez
                    dob: 12/08/1990
                  location_id: loc_67890
                  requested_treatments:
                    - Botox Cosmetic
      responses:
        '201':
          description: In Person visit created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateInPersonResponse'
              examples:
                success:
                  summary: Successful In Person visit creation
                  value:
                    success: true
                    visit_id: gfe_abc123xyz789
                    visit_link: https://client-test.spakinect.com/visit/gfe_abc123xyz789
        '400':
          description: Bad request - Invalid input parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_patient_details:
                  summary: Missing required patient details
                  value:
                    success: false
                    error: >-
                      Missing required patient details (first_name, last_name,
                      dob)
                invalid_dob_format:
                  summary: Invalid date of birth format
                  value:
                    success: false
                    error: Invalid date format. DoB must be in mm/dd/yyyy format
                invalid_treatments:
                  summary: Invalid treatments array
                  value:
                    success: false
                    error: requested_treatments must be a non-empty array
                no_valid_treatments:
                  summary: No valid treatments found
                  value:
                    success: false
                    error: >-
                      No valid treatments found for the requested treatment
                      names
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: >-
        API key provided by Spakinect for EMR integration. This key must be
        associated with at least one location that the EMR system has access to.
  schemas:
    CreateAppointmentRequest:
      type: object
      required:
        - patient_details
        - location_id
        - appointment_time
        - requested_treatments
      properties:
        patient_details:
          $ref: '#/components/schemas/PatientDetails'
        location_id:
          type: string
          description: The ID of the location where the appointment will take place
          example: loc_12345
        appointment_time:
          type: integer
          description: Unix timestamp for the appointment date and time
          example: 1640995200
          minimum: 1
        requested_treatments:
          type: array
          description: List of treatment names requested for this appointment
          items:
            type: string
          minItems: 1
          example:
            - Botox Injection
            - Dermal Filler
      additionalProperties: false
    PatientDetails:
      type: object
      required:
        - first_name
        - last_name
        - email
        - phone
      properties:
        first_name:
          type: string
          description: Patient's first name
          example: John
          minLength: 1
          maxLength: 100
        last_name:
          type: string
          description: Patient's last name
          example: Doe
          minLength: 1
          maxLength: 100
        email:
          type: string
          format: email
          description: Patient's email address
          example: john.doe@example.com
        phone:
          type: string
          description: Patient's phone number
          example: '+1234567890'
          pattern: ^\+?[1-9]\d{1,14}$
      additionalProperties: false
    CreateAppointmentResponse:
      type: object
      required:
        - success
        - gfe_id
      properties:
        success:
          type: boolean
          description: Indicates if the appointment was created successfully
          example: true
        gfe_id:
          type: string
          description: Unique identifier for the created GFE appointment
          example: gfe_abc123xyz789
      additionalProperties: false
    TreatmentsResponse:
      type: object
      required:
        - data
      properties:
        data:
          type: array
          description: List of available treatments
          items:
            $ref: '#/components/schemas/Treatment'
      additionalProperties: false
    Treatment:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: Unique identifier for the treatment
          example: treatment_001
        name:
          type: string
          description: Display name of the treatment
          example: Botox Injection
      additionalProperties: false
    VisitStatusResponse:
      type: object
      required:
        - success
        - data
      properties:
        success:
          type: boolean
          description: Indicates if the request was processed successfully
          example: true
        data:
          $ref: '#/components/schemas/VisitData'
      additionalProperties: false
    VisitData:
      type: object
      required:
        - gfe_id
        - status
        - requested_treatments
        - patient_details
      properties:
        gfe_id:
          type: string
          description: Unique identifier for the GFE visit
          example: gfe_abc123xyz789
        status:
          type: string
          description: Current status of the visit
          enum:
            - Processing
            - Pending Review
            - Approved
            - Completed
            - Cancelled
            - Rejected
          example: Processing
        requested_treatments:
          type: array
          description: List of treatments requested for this visit
          items:
            type: string
          example:
            - Botox Injection
            - Dermal Filler
        patient_details:
          $ref: '#/components/schemas/VisitPatientDetails'
      additionalProperties: false
    VisitPatientDetails:
      type: object
      required:
        - name
        - first_name
        - last_name
        - email
      properties:
        name:
          type: string
          description: Patient's full name
          example: John Doe
        first_name:
          type: string
          description: Patient's first name
          example: John
        last_name:
          type: string
          description: Patient's last name
          example: Doe
        email:
          type: string
          format: email
          description: Patient's email address
          example: john.doe@example.com
      additionalProperties: false
    ErrorResponse:
      type: object
      required:
        - success
        - error
      properties:
        success:
          type: boolean
          description: Always false for error responses
          example: false
        error:
          type: string
          description: Error message describing what went wrong
          example: Missing required patient details
        message:
          type: string
          description: Additional context about the error (optional)
          example: The first_name field is required but was not provided
      additionalProperties: false
  responses:
    BadRequest:
      description: Bad request - Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missing_required_fields:
              summary: Missing required fields
              value:
                success: false
                error: Missing required patient details
            invalid_gfe_id:
              summary: Invalid GFE ID format
              value:
                success: false
                error: GFE ID is required
    Unauthorized:
      description: Unauthorized - Invalid or missing API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            missing_api_key:
              summary: Missing API key
              value:
                success: false
                error: 'Unauthorized: API key is missing.'
            invalid_api_key:
              summary: Invalid API key
              value:
                success: false
                error: 'Forbidden: Invalid API key.'
    Forbidden:
      description: Forbidden - EMR not authorized for requested resource
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            location_access_denied:
              summary: No access to location
              value:
                success: false
                error: EMR is not authorized for this location
            gfe_access_denied:
              summary: No access to GFE
              value:
                success: false
                error: EMR is not authorized to access this GFE
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            gfe_not_found:
              summary: GFE not found
              value:
                success: false
                error: GFE not found
            location_not_found:
              summary: Location not found
              value:
                success: false
                error: Location not found
            endpoint_not_found:
              summary: Endpoint not found
              value:
                success: false
                error: Not found
                message: EMR endpoint /invalid-path not found
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          examples:
            server_error:
              summary: Generic server error
              value:
                success: false
                error: Internal server error
            auth_error:
              summary: Authentication service error
              value:
                success: false
                error: Internal Server Error during authentication.
    CreateInPersonRequest:
      type: object
      required:
        - patient_details
        - location_id
        - requested_treatments
      properties:
        patient_details:
          $ref: '#/components/schemas/IntakePatientDetails'
      IntakePatientDetails:
        type: object
        required:
          - first_name
          - last_name
          - dob
        properties:
          first_name:
            type: string
            description: Patient's first name
            example: Sarah
            minLength: 1
            maxLength: 100
          last_name:
            type: string
            description: Patient's last name
            example: Johnson
            minLength: 1
            maxLength: 100
          dob:
            type: string
            description: Patient's date of birth in MM/DD/YYYY format
            example: 03/15/1985
            pattern: ^(0[1-9]|1[0-2])\/(0[1-9]|[12][0-9]|3[01])\/\d{4}$
      CreateInPersonResponse:
        type: object
        required:
          - success
          - visit_id
          - visit_link
        properties:
          success:
            type: boolean
            description: Indicates if the intake visit was created successfully
            example: true
          visit_id:
            type: string
            description: Unique identifier for the created intake visit
            example: gfe_abc123xyz789
          visit_link:
            type: string
            format: uri
            description: Direct link to the intake form that the patient can access
            example: https://client-test.spakinect.com/visit/gfe_abc123xyz789
  tags:
    - name: Appointments
      description: Operations for creating and managing Good Faith Exam appointments
    - name: Treatments
      description: Operations for retrieving available medical treatments
    - name: InPerson
      description: Operations for creating and managing in-person intake visits
